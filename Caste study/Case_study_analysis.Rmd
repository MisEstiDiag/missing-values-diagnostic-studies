---
title: "Case study"
author: "Katharina Stahlmann"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: yes
  html_document:
    depth: 6
    fig_caption: no
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options:
  chunk_output_type: console
always_allow_html: yes
---

```{r setup, include=FALSE}
rm(list=ls())

knitr::opts_knit$set(root.dir = "C:/Users/stahlmann/Documents/Promotion/Simulationsstudie/Case study/")

# set global chunk options
#knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# this options for word export
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

options(stringsAsFactors = F)
# always show NA is there is any in the table function
table = function (..., useNA = 'ifany') base::table(..., useNA = useNA)

# Note: The complete RMarkdown script takes ca. 45 minutes to run.
```

# Settings

## Packages

```{r packages}
library(mvtnorm)
library(mice)
library(pROC)
library(mitml)
library(mix)
library(mi)
library(ks)
library(ggplot2)
library(reshape2)
library(writexl)
library(ggpubr)
library(haven)
library(dplyr)
library(forcats)
library(gt)
library(arsenal)
```

## load functions

```{r}
setwd("C:/Users/stahlmann/Documents/Promotion/Simulationsstudie/Case study/")
source("functions_AUC_ROC.R")

# set global controls for tableby command
mycontrols = tableby.control(numeric.stats=c("Nmiss","mean", "sd", "medianq1q3", "range"),
                             cat.stats=c("Nmiss", "countpct"), 
                             stats.labels=list(Nmiss='Missing values', medianq1q3='Median (Q1, Q3)'),
                             test = F)
```

# Load and prepare dataset

The dataset nnhs2.dta from the Website https://research.fredhutch.org/diagnostic-biomarkers-center/en/datasets.html is used. A detailed description of this study can be found in Norton et al. (2000).

```{r, results='hide'}
nnhs2 <- read_dta("nnhs2.dta")

# ear: 1=left 2=right
# sitenum: site
# currage: current age
# d: disease (reference test)
# y1: DPOAE
# y2: TEOAE
# y3: ABR

summary(nnhs2)
table(nnhs2$d)
```

In this dataset, missing values (n=2) occur only in the variable currage, neither in the index test(s) nor reference standard. The total sample size is `r length(unique(nnhs2$id))`, of which `r nrow(unique(nnhs2[which(nnhs2$d==1), "id"]))` subjects have the target condition.  

```{r}
# generate original dataset without any missing values
# use only left ear (=1) (no clustered data)
data_full <- nnhs2 %>%
  filter(ear==1 & !is.na(currage)) %>%
  mutate(
    id = as_factor(id),
    ear = as_factor(ear),
    sitenum = as_factor(sitenum),
    gender = as_factor(gender),
    d = as_factor(d)
  )

# generate dataset with missing values
# a priori: define missingness pattern
mypattern <- matrix(nrow = 1, ncol = 9)
mypattern[1, ] <- c(1,1,1,1,1,1,0,1,1) # only y1 (DPOAE) is missing 

```

# Descriptive overview of complete dataset (restricted to left ears and without missing values in the variable age)

```{r, results='asis'}
summary(tableby(d ~ ., data = data_full[,c("sitenum", "currage", "gender", "d", "y1")], control = mycontrols), pfootnote = T) 
```

# MCAR and 30% percent of missing values

```{r}
pm = 0.3
mech = "MCAR"
```

The original dataset (data_full) with restriction to only left ears is used as "true comparison" for the results based on the amputed dataset (data). The latter dataset was generated using the function ampute of the mice package and generates missing values in the variable y1. A percentage of missing values of `r pm` and a missingness mechanism of `r mech` is defined.

## Generating the missing data and calculate AUC and ROC 

```{r, eval=TRUE}

# these calcualtions take a while (ca 20 min)
set.seed(7499)
source("Calculations.R")

res_auc_mcar <- res_auc %>%
  mutate(
    across(c(AUC, CI_lower, CI_upper), as.numeric)
  )

saveRDS(res_auc_mcar, "Ergebnisse/res_auc_MCAR.rds")

roc_mcar <- roc
saveRDS(roc_mcar, "Ergebnisse/res_roc_MCAR.rds") 
```

```{r}
# load data
res_auc_mcar <- readRDS("Ergebnisse/res_auc_MCAR.rds")
roc_mcar <- readRDS("Ergebnisse/res_roc_MCAR.rds")
```

## Results

### Results for the AUC of y1 (DPOAE)

Table 1. The AUC and its CI estimated by each method

```{r}
tab1 <- res_auc_mcar %>%
  mutate(
    across(c(AUC, CI_lower, CI_upper), ~round(.x, 2)),
    ci = paste0("[", CI_lower, ", ", CI_upper, "]")
  ) %>%
  select(-c(CI_lower, CI_upper)) %>%
  gt() %>%
  cols_label(
    Method = "Method",
    AUC = "AUC",
    ci = "Confidence interval"
  )
tab1

```

```{r, fig.width=18, fig.height=11}

# get values for AUC of full dataset
AUC <- res_auc_mcar[which(res_auc_mcar$Method=="CCA full data"), "AUC"]
CIL <- res_auc_mcar[which(res_auc_mcar$Method=="CCA full data"), "CI_lower"]
CIU <- res_auc_mcar[which(res_auc_mcar$Method=="CCA full data"), "CI_upper"]

# plot comparing the AUC estimates
plot1 <- ggplot(res_auc_mcar, aes(x=Method, y=AUC)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=CI_lower, ymax=CI_upper), linewidth=1, width=0.5)  +
  geom_hline(yintercept = AUC, col = "red") +
  geom_hline(yintercept = c( CIL, CIU), col = "red", linetype = "dashed") +
  ggtitle("The AUC and its confidence interval estimated by each method under MCAR") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        plot.title = element_text(size = 20))
plot1
ggsave("Ergebnisse/mcar_AUC.pdf", width = 20, height = 10)
```

The solid red line indicates the AUC estimate calculated by standard complete case analysis based on the full dataset. The dashed red lines show its confidence limits. 

### Results of the ROC

```{r, fig.width=18, fig.height=11}
# plot comparing the ROC curves (without CI),
cols <- c("CONV"="blue","HDEL"="green", "CCA_full"="red", "CCA"="black", "KER"="grey", "MI2"="orange", "MIB2"="purple",
          "mice"="pink", "mix"="yellow", "mi"="brown")

ggplot(data=roc_mcar, aes(x=tt))+
  geom_line(aes(y=ROC.CONV,color="CONV"), linewidth=1)+
  geom_line(aes(y=ROC.CCA_full,color="CCA_full"), linewidth=1)+
  geom_line(aes(y=ROC.CCA,color="CCA"), linewidth=1)+
  geom_line(aes(y=ROC.HDEL,color="HDEL"), linewidth=1)+
  geom_line(aes(y=ROC.KER,color="KER"), linewidth=1)+
  geom_line(aes(y=ROC.MIB2,color="MIB2"), linewidth=1)+
  geom_line(aes(y=ROC.MI2,color="MI2"), linewidth=1)+
  geom_line(aes(y=ROC.mice,color="mice"), linewidth=1)+
  geom_line(aes(y=ROC.mix,color="mix"), linewidth=1)+
  geom_line(aes(y=ROC.mi_,color="mi"), linewidth=1)+
  scale_colour_manual(name="Methods",values=cols) +
  ylab("True Positive Rate") + xlab("False Positive Rate") +
  geom_line(aes(y=tt,color="black")) +
  ggtitle("The ROC estimated by each method under MCAR") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18))
ggsave("Ergebnisse/mcar_ROC.pdf", width = 15, height = 10)

```

The method AIPW is not included in this figure of ROCs as it does not calculate the ROC.

# MAR and 30% percent of missing values

```{r}
pm = 0.3
mech = "MAR"
```

The original dataset (data_full) with restriction to only left ears is used as "true comparison" for the results based on the amputed dataset (data). The latter dataset was generated using the function ampute of the mice packages and generates missing values in the variable y1. A percentage of missing values of `r pm` and a missingness mechanism of `r mech` is defined.

## Generating the missing data and calculate AUC and ROC 

```{r, eval=TRUE}
set.seed(295)
source("Calculations.R")

res_auc_mar <- res_auc %>%
  mutate(
    across(c(AUC, CI_lower, CI_upper), as.numeric)
  )
saveRDS(res_auc_mar, "Ergebnisse/res_auc_MAR.rds")

roc_mar <- roc
saveRDS(roc_mar, "Ergebnisse/res_roc_MAR.rds") 
```

```{r}
# load data
res_auc_mar <- readRDS("Ergebnisse/res_auc_MAR.rds")
roc_mar <- readRDS("Ergebnisse/res_roc_MAR.rds")
```

## Results

### Results for the AUC of y1

Table 2. The AUC and its CI estimated by each method

```{r}
tab1 <- res_auc_mar %>%
  mutate(
    across(c(AUC, CI_lower, CI_upper), ~round(.x, 2)),
    ci = paste0("[", CI_lower, ", ", CI_upper, "]")
  ) %>%
  select(-c(CI_lower, CI_upper)) %>%
  gt() %>%
  cols_label(
    Method = "Method",
    AUC = "AUC",
    ci = "Confidence interval"
  )
tab1

```

```{r, fig.width=18, fig.height=11}

AUC <- res_auc_mar[which(res_auc_mar$Method=="CCA full data"), "AUC"]
CIL <- res_auc_mar[which(res_auc_mar$Method=="CCA full data"), "CI_lower"]
CIU <- res_auc_mar[which(res_auc_mar$Method=="CCA full data"), "CI_upper"]

plot1 <- ggplot(res_auc_mar, aes(x=Method, y=AUC)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=CI_lower, ymax=CI_upper), linewidth=1, width=0.5)  +
  geom_hline(yintercept = AUC, col = "red") +
  geom_hline(yintercept = c( CIL, CIU), col = "red", linetype = "dashed") +
  ggtitle("The AUC and its confidence interval estimated by each method under MAR") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        plot.title = element_text(size = 20))
plot1
ggsave("Ergebnisse/mar_AUC.pdf", width = 20, height = 10)
```

The solid red line indicates the AUC estimate calculated by standard complete case analysis based on the full dataset. The dashed red lines show its confidence limits. 

### Results of the ROC

```{r, fig.width=18, fig.height=11}
cols <- c("CONV"="blue","HDEL"="green", "CCA_full"="red", "CCA"="black", "KER"="grey", "MI2"="orange", "MIB2"="purple",
          "mice"="pink", "mix"="yellow", "mi"="brown")

ggplot(data=roc_mar, aes(x=tt))+
  geom_line(aes(y=ROC.CONV,color="CONV"), linewidth=1)+
  geom_line(aes(y=ROC.CCA_full,color="CCA_full"), linewidth=1)+
  geom_line(aes(y=ROC.CCA,color="CCA"), linewidth=1)+
  geom_line(aes(y=ROC.HDEL,color="HDEL"), linewidth=1)+
  geom_line(aes(y=ROC.KER,color="KER"), linewidth=1)+
  geom_line(aes(y=ROC.MIB2,color="MIB2"), linewidth=1)+
  geom_line(aes(y=ROC.MI2,color="MI2"), linewidth=1)+
  geom_line(aes(y=ROC.mice,color="mice"), linewidth=1)+
  geom_line(aes(y=ROC.mix,color="mix"), linewidth=1)+
  geom_line(aes(y=ROC.mi_,color="mi"), linewidth=1)+
  scale_colour_manual(name="Estimations",values=cols) +
  ylab("True Positive Rate") + xlab("False Positive Rate") +
  geom_line(aes(y=tt,color="black")) +
  ggtitle("The ROC estimated by each method under MAR") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18))
ggsave("Ergebnisse/mar_ROC.pdf", width = 15, height = 10)

```


# MNAR and 30% percent of missing values

```{r}
pm = 0.3
mech = "MNAR"
```

The original dataset (data_full) with restriction to only left ears is used as "true comparison" for the results based on the amputed dataset (data). The latter dataset was generated using the function ampute of the mice packages and generates missing values in the variable y1. A percentage of missing values of `r pm` and a missingness mechanism of `r mech` is defined.

## Generating the missing data and calculate AUC and ROC 

```{r, eval=TRUE}
set.seed(682)
source("Calculations.R")

res_auc_mnar <- res_auc %>%
  mutate(
    across(c(AUC, CI_lower, CI_upper), as.numeric)
  )
saveRDS(res_auc_mnar, "Ergebnisse/res_auc_MNAR.rds")

roc_mnar <- roc
saveRDS(roc_mnar, "Ergebnisse/res_roc_MNAR.rds") 
```

```{r}
# load data
res_auc_mnar <- readRDS("Ergebnisse/res_auc_MNAR.rds")
roc_mnar <- readRDS("Ergebnisse/res_roc_MNAR.rds")
```

## Results

### Results for the AUC of y1

Table 2. The AUC and its CI estimated by each method

```{r}
tab1 <- res_auc_mnar %>%
  mutate(
    across(c(AUC, CI_lower, CI_upper), ~round(.x, 2)),
    ci = paste0("[", CI_lower, ", ", CI_upper, "]")
  ) %>%
  select(-c(CI_lower, CI_upper)) %>%
  gt() %>%
  cols_label(
    Method = "Method",
    AUC = "AUC",
    ci = "Confidence interval"
  )
tab1

```

```{r, fig.width=18, fig.height=11}
AUC <- res_auc_mnar[which(res_auc_mnar$Method=="CCA full data"), "AUC"]
CIL <- res_auc_mnar[which(res_auc_mnar$Method=="CCA full data"), "CI_lower"]
CIU <- res_auc_mnar[which(res_auc_mnar$Method=="CCA full data"), "CI_upper"]

plot1 <- ggplot(res_auc_mnar, aes(x=Method, y=AUC)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=CI_lower, ymax=CI_upper), linewidth=1, width=0.5)  +
  geom_hline(yintercept = AUC, col = "red") +
  geom_hline(yintercept = c( CIL, CIU), col = "red", linetype = "dashed") +
  ggtitle("The AUC and its confidence interval estimated by each method under MNAR") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        plot.title = element_text(size = 20))
plot1
ggsave("Ergebnisse/mnar_AUC.pdf", width = 20, height = 10)
```

The solid red line indicates the AUC estimate calculated by standard complete case analysis based on the full dataset. The dashed red lines show its confidence limits. 

### Results of the ROC

```{r, fig.width=18, fig.height=11}
cols <- c("CONV"="blue","HDEL"="green", "CCA_full"="red", "CCA"="black", "KER"="grey", "MI2"="orange", "MIB2"="purple",
          "mice"="pink", "mix"="yellow", "mi"="brown")

ggplot(data=roc_mnar, aes(x=tt))+
  geom_line(aes(y=ROC.CONV,color="CONV"), linewidth=1)+
  geom_line(aes(y=ROC.CCA_full,color="CCA_full"), linewidth=1)+
  geom_line(aes(y=ROC.CCA,color="CCA"), linewidth=1)+
  geom_line(aes(y=ROC.HDEL,color="HDEL"), linewidth=1)+
  geom_line(aes(y=ROC.KER,color="KER"), linewidth=1)+
  geom_line(aes(y=ROC.MIB2,color="MIB2"), linewidth=1)+
  geom_line(aes(y=ROC.MI2,color="MI2"), linewidth=1)+
  geom_line(aes(y=ROC.mice,color="mice"), linewidth=1)+
  geom_line(aes(y=ROC.mix,color="mix"), linewidth=1)+
  geom_line(aes(y=ROC.mi_,color="mi"), linewidth=1)+
  scale_colour_manual(name="Estimations",values=cols) +
  ylab("True Positive Rate") + xlab("False Positive Rate") +
  geom_line(aes(y=tt,color="black")) +
  ggtitle("The ROC estimated by each method under MNAR") +
  theme(axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18))
ggsave("Ergebnisse/mnar_ROC.pdf", width = 15, height = 10)
```

# Session Info

```{r}
sessionInfo()
```












